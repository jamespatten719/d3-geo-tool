<!DOCTYPE html>
<head>
	<meta charset="utf-8">
	<!-- cartodb.js comes with Leaflet @0.7 and jQuery -->
	<link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/3.15/themes/css/cartodb.css" />
	<link rel="stylesheet" href= "https://code.jquery.com/ui/1.12.1/themes/ui-lightness/jquery-ui.css" />

	<script src="http://libs.cartocdn.com/cartodb.js/v3/3.15/cartodb.js"></script>
	<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
	<script src="http://api.tiles.mapbox.com/mapbox.js/plugins/turf/v2.0.0/turf.min.js"></script>
	<script src="https://d3js.org/d3.v5.js"></script>
	<!-- This script makes it easy to use Stamen basemaps   -->
	<script type="text/javascript" src="http://maps.stamen.com/js/tile.stamen.js?v1.3.0"></script>

	<title>Health Buffer POC</title>
	<style>
		body {
			margin: 0;
			position: fixed;
			top: 0;
			right: 0;
			bottom: 0;
			left: 0;
		}
		
		#banner {
			height: 50px;
			width: 100%;
			background-color: #000000;
		}

		#sidepane {
			position: absolute;
			height: 100%;
			width: 500px;
			top: 50px;
			right: 0px;
			z-index: 1;
			background: #ffffff;
			border: 1px solid #ccc;
			font-size: 14px;		
		}
		
		#poptotalBox {
			position: relative;
			height: 150px;
			width: 500px;
			top: 0px;
			right: 0px;
			z-index: 1;
			background: #e6e6e6;		
		}
		

		#map {
			height: 100%;
			
		}
		
		#spinnerbox {
			position: absolute;
			bottom: 60px;
			right: 100px
			}

		#spinner {
			height: 20px;
			width: 40px;
			font-size: 14px;	
		}
		
		#charts {
				
			padding: 10px;
			position: absolute;
			z-index: 1;
			background-color: white;
			border: 1px solid #ccc;
			height: 170px;
			width: 415px;
			overflow: overlay;
			top: 280px;
			left: 30px;
			
		}
		#toggleChart {
			position: absolute;
			height: 20px;
			width: 52px;
			z-index: 1;
			right: 3px;
			font-size: 10px;
			color: black;
			margin: 5px;
			bottom: 60px;
		}
		#poptotal {
			position: absolute;
			font-weight: bold;
			font-size: 60px;
			font-family: sans-serif;
			color: #9ACD66;
			right: 30px;
			bottom: 20px;	
		}
		
		#infected {
			position: absolute;
			font-family: sans-serif;
			font-size: 12px;
			color: #9ACD66;
			right: 30px;
			bottom: 0px;	
		}
		
		#question {
			position: absolute;
			font-family: sans-serif;
			font-size: 20px;
			color: #4b4b4b;
			left: 30px;
			top: 165px;
		}
		
		#charthead {
			position: absolute;
			font-family: sans-serif;
			font-size: 24px;
			font-weight: bold;
			color: #4b4b4b;
			left: 30px;
			top: 220px;
		}
		
		#breaker {
			position: absolute;
			height: 2px;
			width: 385px;
			top: 269px;
			left: 30px;
			z-index: 1;
			background: #e6e6e6;
		
		}
		.chart rect {
			fill: #9ACD66;
			shape-rendering: crispEdges;
			hover-fill: black;
		}
		
		.chart rect:hover {
		  fill: black;
		}

		.chart text {
			fill: black;
			font: 14px sans-serif;
			text-anchor: end;
			font-weight: bold;
		}
	
	</style>
</head>

<body>
	<div id="banner"><img src="logo.jpg" style="height:50px; " />
	</div>
	<div id="sidepane">
		<div id = poptotalBox class = "poptotalBox">  
			<div id = "poptotal" class = "poptotal">0</div>
			<p id = "infected" class = "infected">out of <b>8,000,000</b> infected (0%)</p> 
		</div>
		
		<h1 id = "question" class="question">How many of the infected can you save?</h1>
		
		<h2 id = "charthead" class = "charthead">Pin Drops</h2>
		
		<div id = "breaker" class = "breaker"></div> 
		
		<div id="charts">
			<svg id="barchart" class="chart"></svg>
		</div>
		
		<div id="toggleChart">
			Show/Hide Chart
		</div>
		
		<div id="spinnerbox" class = "spinnerbox">
			<label for="spinner">Radius (m):</label>
			<input id="spinner" name="value" value="1000">
		</div>
		
		
	</div>
	<div id="map"></div>
	
	<script>
		// necessary for making AJAX calls on Blockbuilder.org as of 2016-11-02
		jQuery.support.cors = true;
		// create a new map centered on London.
		var map = L.map('map').setView([51.47, 0.25], 10);
		map.on('click', onMapClick);
		// create a tile layer for our toner basemap
		var tonerLayer = new L.StamenTileLayer("toner");
		map.addLayer(tonerLayer);
		
		// add cartodb layer with one sublayer
		cartodb.createLayer(map, {
			user_name : 'deloitte-uk-admin',
			type : 'cartodb',
			sublayers : [{
				sql : 'select * from infuse_dist_lyr_2011_1',
				cartocss : '#infuse_dist_lyr_2011{ polygon-fill: #000000; polygon-opacity: 0.4; line-color: #000000; line-width: 0.5; line-opacity: 1; }',
				interactivity : 'cartodb_id'
			}]
		}).addTo(map).done(function(layer) {
			console.log("done");
		});

		// Set up our GeoJSON layers, add them to the map, but don't add data just yet
		var bufferLayer = L.geoJson(null).addTo(map);

		var geojsonMarkerOptions = {
			radius : 4,
			fillColor : "#9ACD66",
			color : "#000",
			weight : 1,
			opacity : 1,
			fillOpacity : 0.8
		};
		var OAcentroidLayer = L.geoJson(null, {
			pointToLayer : function(feature, latlng) {
				return L.circleMarker(latlng, geojsonMarkerOptions);
			}
		}).addTo(map);

		//global variable to hold population in buffer
		var population = [0];
		
		//add variable to hold total
		var totalDiv = d3.select("#poptotal");
		totalDiv.append("text");

		//Setup the map click event
		function onMapClick(e) {
			//Add a circle to represent the buffer zone
			//Note: Cirlce size is reduced by 33% to match SQL query results - there is some coordinate
			//reference stuff going on here - world is not flat.
			var bufferDist = $('#spinner').val();
			L.circle(e.latlng, bufferDist * 0.66, {
				color : "#9ACD66"
			}).addTo(map);

			//I've created a layer using turf.js to do geogrpahic buffering. Hidden layer.
			var pt = {
				"type" : "Feature",
				"properties" : {},
				"geometry" : {
					"type" : "Point",
					"coordinates" : [e.latlng.lng, e.latlng.lat]
				}
			};
			var buffered = turf.buffer(pt, bufferDist, 'meters');
			//bufferLayer.addData(buffered);

			//query OA centroid layer
			//var query = "SELECT * FROM lon_oa_residents_geocode ";
			var query = "SELECT * FROM infuse_dist_lyr_2011 ";
			//query += "objectid = 146320";
			// query += "WHERE ST_Intersects(infuse_dist_lyr_2011.the_geom, ";
			// query += "ST_SetSRID(ST_MakePoint(" + e.latlng.lng + ", " + e.latlng.lat + "),4326))";

			query = "SELECT * FROM lon_oa_residents_geocode ";
			query += "WHERE ST_DWithin(lon_oa_residents_geocode.the_geom_webmercator, ";
			query += "ST_Transform(ST_SetSRID(ST_MakePoint(" + e.latlng.lng + ", " + e.latlng.lat + "),4326),3857),";
			query += bufferDist + ")";
			console.log(query);

			var sql = new cartodb.SQL({
				user : 'deloitte-uk-admin'
			});
			sql.execute(query, null, {
				format : 'geojson'
			}).done(function(data) {
				console.log(data);
				//update the population
				var newPopulation = 0;
				for (var item in data.features) {
					newPopulation += data.features[item].properties.all_usual_;
				}
				
				population[0] += newPopulation;
				population.push(newPopulation);
				console.log(population);
							
				OAcentroidLayer.addData(data);
				// update charts
				doCharts();
				
						
				//transition for total 
				totalDiv.transition().duration(1000)
				.tween("text", testtween(population[0]));
				var format = d3.format(",d")
				//generate tween animation 
				function testtween(a) {
					return function () {
						var node = d3.select(this),
							i = d3.interpolateNumber(node.text().replace(/,/g, ""), a);
					return function(t) {
					  node.text(format(i(t)));
					};
				  };
				}
									
				testtween()
			
				//calculate percentage of infected saved 
				var infected = (population[0]/8000000) * 100;
				var infectedround = Math.round(infected);
				var total = "8,000,000";
				var totalbold = total.bold();
			    document.getElementById("infected").innerHTML= "out of" + " " + totalbold + " " + "infected (" + infectedround + "%)";	
					
			});
			
				
		};

		//setup the JQuery UI controls
		$(function() {
			var spinner = $("#spinner").spinner({
				min : 500,
				max : 5000,
				step : 500
			});
			//$("#charts").draggable();
			$("#toggleChart").button();
			$("#toggleChart").click(function(event) {
				$("#charts").toggle();
			});
		});
		
		//D3 Chart Stuff
		function doCharts() {
			d3.selectAll("#barchart > *").remove();
			var data = population.slice(1); //remove total from the bar chart 
			var width = 415, barHeight = 20;
			var x = d3.scaleLinear().domain([0, d3.max(data)]).range([0, width - 55]);
			var chart = d3.select(".chart").attr("width", width).attr("height", barHeight * data.length).append("svg");
			//var xAxis = d3.svg.axis().scale(x).orient("bottom");
			var bar = chart.selectAll("g").data(data).enter().append("g").attr("transform", function(d, i) {
				return "translate(10," + i * barHeight + ")";
			});
			bar.append("rect").attr("height", barHeight -1).attr("width", 0).transition().duration(1000).attr("width", x); //adding animation to the bars
			bar.append("text").attr("x", function(d) {
				return x(d) + 45;
			}).attr("y", barHeight / 2).attr("dy", ".35em").text(function(d) {
				return numberWithCommas(d);
			});
			
		}

		//update charts
		function updateCharts(data) {
			
		}

		const numberWithCommas = (x) => {
			return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
		}	
		
		
		
				
		
	</script>
</body>